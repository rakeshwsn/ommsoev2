<?php

namespace App\Models;

use CodeIgniter\Model;

class TransactionModel extends Model
{
    protected $DBGroup              = 'default';
    protected $table                = 'soe_misc_transactions';
    protected $primaryKey           = 'id';
    protected $useAutoIncrement     = true;
    protected $returnType           = 'object';
    protected $useSoftDeletes        = true;
    protected $protectFields        = false;
    protected $allowedFields        = [
        'block_id', 'district_id', 'agency_type_id', 'year', 'month', 'created_at', 'status', 'user_id', 'remarks'
    ];

    // Dates
    protected $useTimestamps        = true;
    protected $dateFormat           = 'datetime';
    protected $createdField         = 'created_at';
    protected $updatedField         = '';
    protected $deletedField         = 'deleted_at';

    // Validation
    protected $validationRules      = [];
    protected $validationMessages   = [];
    protected $skipValidation       = false;
    protected $cleanValidationRules = true;

    // Callbacks
    protected $allowCallbacks       = true;
    protected $beforeInsert         = [];
    protected $afterInsert          = [];
    protected $beforeUpdate         = [];
    protected $afterUpdate          = [];
    protected $beforeFind           = [];
    protected $afterFind            = [];
    protected $beforeDelete         = [];
    protected $afterDelete          = [];

    public function getHeads()
    {
        return $this->db->query("SELECT * FROM soe_misc_txn_heads")->getResult();
    }

    public function getAll($filter = [])
    {
        $sql = "SELECT
                  mt.id,
                  y.name `year`,
                  m.name `month`,
                  mt.created_at,
                  in_amt.credit,
                  out_amt.debit,
                  mt.status
                FROM soe_misc_transactions mt
                LEFT JOIN soe_months m ON m.id = mt.month
                LEFT JOIN (
                    SELECT
                      mta.txn_id,
                      SUM(mta.amount) credit
                    FROM soe_misc_txn_amt mta
                    LEFT JOIN soe_misc_txn_heads mth ON mta.head_id = mth.id
                    WHERE mth.txn_type = 'in'
                    GROUP BY mta.txn_id
                ) in_amt ON mt.id = in_amt.txn_id
                LEFT JOIN (
                    SELECT
                      mta.txn_id,
                      SUM(mta.amount) debit
                    FROM soe_misc_txn_amt mta
                    LEFT JOIN soe_misc_txn_heads mth ON mta.head_id = mth.id
                    WHERE mth.txn_type = 'out'
                    GROUP BY mta.txn_id
                ) out_amt ON mt.id = out_amt.txn_id
                LEFT JOIN soe_years y ON y.id = mt.year
                WHERE mt.deleted_at IS NULL";

        if (isset($filter['agency_type_id'])) {
            $sql .= " AND mt.agency_type_id = " . $filter['agency_type_id'];
        }
        if (isset($filter['user_id'])) {
            $sql .= " AND mt.user_id = " . $filter['user_id'];
        }

        $order = !empty($filter['sort']) && $filter['sort'] == 'asc' ? 'ASC' : 'DESC';
        $sort = !empty($filter['sort']) ? $filter['sort'] : "mt.year DESC, mt.month";

        if (isset($filter['start']) || isset($filter['limit'])) {
            if ($filter['start'] < 0) {
                $filter['start'] = 0;
            }

            if ($filter['limit'] < 1) {
                $filter['limit'] = 10;
            }
        }

        $sql .= " ORDER BY $sort $order ";

        $sql .= " LIMIT " . $filter['start'] . ', ' . $filter['limit'];

        return $this->db->query($sql)->getResult();
    }

    public function getTotal($filter = [])
    {
        $sql = "SELECT
                  COUNT(*) total
                FROM soe_misc_transactions t
                WHERE t.deleted_at IS NULL";

        if (isset($filter['agency_type_id'])) {
            $sql .= " AND t.agency_type_id = " . $filter['agency_type_id'];
        }
        if (isset($filter['user_id'])) {
            $sql .= " AND t.user_id = " . $filter['user_id'];
        }

        return $this->db->query($sql)->getRow()->total;
    }

    public function getTotalAmount($filter = [])
    {
        $sql = "SELECT
                  COALESCE(SUM(IF(mt.txn_type = 'out', -1, 1) * mt.total),0) total
                FROM (
                    SELECT
                      COALESCE(SUM(mta.amount), 0) total,
                      mth.txn_type
                    FROM soe_misc_transactions mt
                    LEFT JOIN soe_misc_txn_amt mta ON mt.id = mta.txn_id
                    LEFT JOIN soe_misc_txn_heads mth ON mta.head_id = mth.id
                    WHERE mt.deleted_at IS NULL
                    AND mta.deleted_at IS NULL";

        if (isset($filter['block_id'])) {
